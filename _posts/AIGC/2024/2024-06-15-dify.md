---
layout: post
title: Dify ä½¿ç”¨ç¬”è®°
excerpt: "difyä½¿ç”¨çš„è®°å½•"
modified: 
tags: [AIå·¥å…·, éƒ¨ç½²]
comments: true
category: GenAI

---



## ä»Dockerä¸­è°ƒç”¨æœ¬åœ°å¤§æ¨¡å‹



æ•…éšœï¼šç›´æ¥è¾“å…¥æœ¬åœ°åŒ–å¤§æ¨¡å‹localhostå°±æ˜¯ä¼šä¸€ç›´è¿ä¸ä¸Š

åŸå› ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨å†…éƒ¨æ— æ³•ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ç½‘ç»œæœåŠ¡ã€‚å› æ­¤ï¼Œéœ€è¦ä¸€ç§æ–¹å¼æ¥ä½¿å®¹å™¨å†…éƒ¨çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—®å®¿ä¸»æœºæä¾›çš„æœåŠ¡ã€‚

è§£å†³ï¼šhttp://host.docker.internal:11434

>`http://host.docker.internal` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ DNS åç§°ï¼Œåœ¨ Windows å’Œ MacOS ä¸Šçš„ Docker Desktop æä¾›ï¼Œç”¨äºè®©å®¹å™¨è®¿é—®å®¿ä¸»æœºçš„ç½‘ç»œæœåŠ¡ã€‚è¿™æ˜¯ Docker æä¾›çš„ä¸€ç§ä¾¿æ·æ–¹å¼ï¼Œä½¿å®¹å™¨å†…éƒ¨çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿé€šè¿‡è¿™ä¸ªåœ°å€è®¿é—®å®¿ä¸»æœºã€‚



## ollamaè¿è¡Œæœ¬åœ°å¤§æ¨¡å‹

å®˜ç½‘ï¼šhttps://ollama.com



## å¸¸è§å‘½ä»¤

```Terminal
# æ˜¾ç¤ºæœ¬åœ°å·²ç»å®‰è£…çš„å¤§æ¨¡å‹
ollama list

# è¿è¡Œæœ¬åœ°å¤§æ¨¡å‹
ollama qwen2:7b



```



## æ›´æ–°Dify

Difyéš”ä¸€æ®µæ—¶é—´å°±ä¼šæ›´æ–°ï¼Œç›®å‰æ˜¯ä¸€æ›´æ–°å°±ä¼šå¤±å»æ‰€æœ‰çš„é…ç½®ï¼Œä¿¡æ¯

```Terminal
# å¤åˆ¶æœ€æ–°Dify åˆ°æœ¬åœ°åŒ–
git clone https://github.com/langgenius/dify.git


# å‡çº§æŒ‡ä»¤
cd dify/docker
docker compose down
git pull origin main
docker compose pull
docker compose up -d

```



# å·¥ä½œæµ

## å…ˆæœºå™¨ç¿»è¯‘å†æ¶¦è‰²

![workflow](/assets/blog-images/2024/08/workflow.png)





å¯¼å‡ºçš„DSLæ–‡ä»¶

{% raw %}
```
app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: smartrans
kind: app
version: 0.1.1
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        sourceType: start
        targetType: tool
      id: 1723860987072-source-1723861027680-target
      source: '1723860987072'
      sourceHandle: source
      target: '1723861027680'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: tool
        targetType: llm
      id: 1723861027680-source-1723861128111-target
      source: '1723861027680'
      sourceHandle: source
      target: '1723861128111'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: llm
        targetType: end
      id: 1723861128111-source-1723861135345-target
      source: '1723861128111'
      sourceHandle: source
      target: '1723861135345'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: Please input the text to translate
        selected: false
        title: Start
        type: start
        variables:
        - label: Text to Translate
          max_length: null
          options: []
          required: true
          type: paragraph
          variable: text2translate
      height: 118
      id: '1723860987072'
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        provider_id: google_translate
        provider_name: google_translate
        provider_type: builtin
        selected: false
        title: Translate
        tool_configurations:
          dest: zh-cn
        tool_label: Translate
        tool_name: translate
        tool_parameters:
          content:
            type: mixed
            value: '{{#1723860987072.text2translate#}}'
        type: tool
      height: 90
      id: '1723861027680'
      position:
        x: 384
        y: 282
      positionAbsolute:
        x: 384
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: gpt-4o
          provider: azure_openai
        prompt_template:
        - id: 50e227d0-4370-4f08-8daa-2bf8403fef89
          role: system
          text: 'è¯·å¯¹ç…§åŸæ–‡å¯¹è¯‘æ–‡è¿›è¡Œæ¶¦è‰²ï¼Œæœ€åè¾“æ¶¦è‰²åçš„è¯‘æ–‡ã€‚


            åŸæ–‡ï¼š

            {{#1723860987072.text2translate#}}


            è¯‘æ–‡ï¼š

            {{#1723861027680.text#}}

            '
        selected: false
        title: LLM
        type: llm
        variables: []
        vision:
          configs:
            detail: high
          enabled: true
      height: 98
      id: '1723861128111'
      position:
        x: 689
        y: 282
      positionAbsolute:
        x: 689
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1723861128111'
          - text
          variable: translation
        selected: false
        title: End
        type: end
      height: 90
      id: '1723861135345'
      position:
        x: 992
        y: 282
      positionAbsolute:
        x: 992
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: 59.514009473272836
      y: 15.001932860512056
      zoom: 1.0482624755169463

```
{% endraw %}



## é•¿æ–‡æ¡£ç”Ÿæˆå™¨

è®©ChatGPTç›´æ¥å†™é•¿æ–‡æ¡£ï¼ŒChatGPTæ¯”è¾ƒéš¾å†™å¾ˆé•¿çš„æ–‡æ¡£ã€‚

è§£å†³æ€è·¯ï¼š

æ¥å—ç”¨æˆ·è¾“å…¥æ–‡ç« æ ‡é¢˜å’Œæçº²ï¼Œç„¶åç”±LLMåŸºäºæ ‡é¢˜å’Œå¤§çº²ï¼Œç”Ÿæˆæ›´è¯¦ç»†çš„äºŒçº§æçº²ï¼Œç„¶åå°†äºŒçº§æçº²äº¤ç»™LLMè¿›è¡Œå†™ä½œï¼Œå†™å®Œåæ‹¼æˆä¸€ç¯‡å®Œæ•´çš„æ–‡ç« ã€‚



éš¾ç‚¹ï¼š

1. è®©å¤§æ¨¡å‹ç”ŸæˆJSONæ ¼å¼
2. å°†JSONå¤æ‚æ•°æ®æå–å‡ºæ‰€éœ€å†…å®¹ååŠ å·¥ä¸ºè¯å…¸
3. è¿­ä»£æ¯ä¸ªèŠ‚ç‚¹ï¼Œè®©å¤§æ¨¡å‹å°±æ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆå†…å®¹
4. æœ€åç”¨æ¨¡æ¿è¾“å‡ºä¸ºå¯è¯»çš„æ–‡ç« 





## å¤§æ¨¡å‹åŸºç¡€

### æ‰€éœ€å†…å­˜

ä»¥ollama è¿è¡Œåƒé—®7bæ¨¡å‹(qwen2:7b)ä¸ºä¾‹ï¼š

7bä¹Ÿå°±æ˜¯70äº¿å‚æ•°ï¼Œå¤§æ¨¡å‹è¿è¡Œçš„æ—¶å€™éœ€è¦å°†æ¨¡å‹å‚æ•°å…¨éƒ¨è£…å…¥å†…å®¹ï¼Œæ¯ä¸ªå‚æ•°4å­—èŠ‚çš„è¯ï¼Œå°±æ˜¯280äº¿ä¸ªå­—èŠ‚ï¼ˆçº¦28Gå†…å­˜ï¼‰ã€‚ä¸­é—´è®¡ç®—å­˜å‚¨å’Œæ¡†æ¶å¼€é”€ä¹Ÿéœ€è¦ä¸€äº›å†…å­˜ï¼Œç»¼åˆæ¥çœ‹ï¼š

- **æ¨ç†é˜¶æ®µ**ï¼šé€šå¸¸éœ€è¦å¤§çº¦**40GBåˆ°50GB**çš„å†…å­˜æ¥è¿è¡Œä¸€ä¸ª7Bå‚æ•°çš„æ¨¡å‹ã€‚

- **è®­ç»ƒé˜¶æ®µ**ï¼šè®­ç»ƒæ‰€éœ€çš„å†…å­˜ä¼šæ›´å¤šï¼Œå› ä¸ºè¿˜éœ€è¦å­˜å‚¨ä¼˜åŒ–å™¨çŠ¶æ€å’Œæ¢¯åº¦ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦ä¸¤åˆ°ä¸‰å€äºæ¨ç†é˜¶æ®µçš„å†…å­˜ã€‚

### é‡åŒ–

é‡åŒ–çš„è¿‡ç¨‹é€šå¸¸æ¶‰åŠå°†æ¨¡å‹å‚æ•°ä»32ä½æµ®ç‚¹æ•°ï¼ˆFP32ï¼‰è½¬æ¢ä¸º16ä½æµ®ç‚¹æ•°ï¼ˆFP16ï¼‰æˆ–8ä½æ•´æ•°ï¼ˆINT8ï¼‰ã€‚

- **FP32åˆ°FP16é‡åŒ–**ï¼šæ¨¡å‹å‚æ•°ä¼šä»åŸæ¥çš„32ä½æµ®ç‚¹æ•°å‹ç¼©åˆ°16ä½æµ®ç‚¹æ•°ï¼Œè¿™å°†ä½¿å†…å­˜éœ€æ±‚å‡å°‘ä¸€åŠã€‚å¯¹äº7Bå‚æ•°çš„æ¨¡å‹ï¼Œå‚æ•°å­˜å‚¨éœ€æ±‚å¤§çº¦ä¼šä»28GBå‡å°‘åˆ°14GBã€‚

- **FP32åˆ°INT8é‡åŒ–**ï¼šæ¨¡å‹å‚æ•°ä¼šä»32ä½æµ®ç‚¹æ•°å‹ç¼©åˆ°8ä½æ•´æ•°ï¼Œè¿™å°†ä½¿å†…å­˜éœ€æ±‚å‡å°‘åˆ°å››åˆ†ä¹‹ä¸€ã€‚å¯¹äº7Bå‚æ•°çš„æ¨¡å‹ï¼šå‚æ•°å­˜å‚¨éœ€æ±‚å¤§çº¦ä¼šä»28GBå‡å°‘åˆ°7GBã€‚

- **FP32INT4é‡åŒ–**ï¼šæ¨¡å‹å‚æ•°ä¼šä»32ä½æµ®ç‚¹æ•°å‹ç¼©åˆ°4ä½æ•´æ•°ï¼Œè¿™å°†ä½¿å†…å­˜éœ€æ±‚å‡å°‘åˆ°åŸæ¥çš„å…«åˆ†ä¹‹ä¸€ã€‚å¯¹äº7Bå‚æ•°çš„æ¨¡å‹ï¼Œå‚æ•°å­˜å‚¨éœ€æ±‚å¤§çº¦ä¼šä»28GBå‡å°‘åˆ°3.5GBã€‚



72Bå¤§æ¨¡å‹

| é‡åŒ–æ–¹å¼     | æ¨ç†å†…å­˜         |
| ------------ | ---------------- |
| **FP32æ¨¡å‹** | 350GBåˆ°400GBå†…å­˜ |
| **FP16é‡åŒ–** | 175GBåˆ°200GBå†…å­˜ |
| **INT8é‡åŒ–** | 85GBåˆ°100GBå†…å­˜  |



### ç²¾åº¦æŸå¤±

**FP16é‡åŒ–**

- **ä¼˜ç‚¹**ï¼šç›¸æ¯”FP32ï¼ŒFP16é‡åŒ–å¯¹ç²¾åº¦çš„å½±å“è¾ƒå°ã€‚å¤§å¤šæ•°æ·±åº¦å­¦ä¹ æ¨¡å‹åœ¨è½¬æ¢åˆ°FP16åï¼Œæ€§èƒ½å‡ ä¹ä¸å˜ã€‚
- **ç²¾åº¦æŸå¤±**ï¼šé€šå¸¸åœ¨1%ä»¥å†…ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚
- **åº”ç”¨åœºæ™¯**ï¼šå¸¸ç”¨äºè®­ç»ƒå’Œæ¨ç†é˜¶æ®µï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿåœ¨å‡å°‘å†…å­˜ä½¿ç”¨çš„åŒæ—¶ä¿æŒé«˜ç²¾åº¦ã€‚

**INT8é‡åŒ–**

- **ä¼˜ç‚¹**ï¼šèƒ½å¤Ÿæ˜¾è‘—å‡å°‘å†…å­˜å’Œè®¡ç®—èµ„æºéœ€æ±‚ã€‚
- **ç²¾åº¦æŸå¤±**ï¼šåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç²¾åº¦æŸå¤±åœ¨1%åˆ°5%ä¹‹é—´ã€‚ä¸è¿‡ï¼Œå¯¹äºæŸäº›æ•æ„Ÿä»»åŠ¡æˆ–æ¨¡å‹ï¼Œç²¾åº¦æŸå¤±å¯èƒ½ä¼šæ›´é«˜ã€‚
- **åº”ç”¨åœºæ™¯**ï¼šä¸»è¦ç”¨äºæ¨ç†é˜¶æ®µï¼Œç‰¹åˆ«æ˜¯åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šï¼Œå¦‚ç§»åŠ¨è®¾å¤‡å’ŒåµŒå…¥å¼ç³»ç»Ÿã€‚

**INT4é‡åŒ–**

- **ä¼˜ç‚¹**ï¼šè¿›ä¸€æ­¥å‡å°‘å†…å­˜å’Œè®¡ç®—èµ„æºéœ€æ±‚ï¼Œé€‚ç”¨äºæç«¯èµ„æºå—é™çš„ç¯å¢ƒã€‚
- **ç²¾åº¦æŸå¤±**ï¼šé€šå¸¸æ¯”INT8é«˜ï¼Œå¯èƒ½åœ¨5%åˆ°10%ä¹‹é—´ï¼Œæœ‰æ—¶ç”šè‡³æ›´å¤šã€‚å¯¹äºæŸäº›ä»»åŠ¡ï¼Œç²¾åº¦æŸå¤±å¯èƒ½ä¸å¯æ¥å—ã€‚
- **åº”ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºå¯¹ç²¾åº¦è¦æ±‚ä¸é«˜æˆ–å¯ä»¥å®¹å¿è¾ƒå¤§ç²¾åº¦æŸå¤±çš„ä»»åŠ¡ã€‚



### é€Ÿåº¦

ollama æ¨ç†é€Ÿåº¦è¾ƒå¿«ï¼Œæ˜¯å› ä¸ºå®ƒè¿è¡Œçš„æ¨¡å‹æ˜¯ç»è¿‡ GGUF ( GPT-Generated Unified Formatï¼‰æ–¹å¼é‡åŒ–çš„ï¼Œä»è€Œå‡å°‘æ¨¡å‹çš„å­˜å‚¨éœ€æ±‚å’Œè®¡ç®—é‡ã€‚è¿™ç§æ–¹å¼å…è®¸ç”¨æˆ·ä½¿ç”¨CPUæ¥è¿è¡ŒLLMï¼Œä¹Ÿå¯ä»¥å°†æŸäº›å±‚åŠ è½½åˆ°GPUä»¥æé«˜é€Ÿåº¦ã€‚å½“ç„¶é€Ÿåº¦æå‡æ˜¯ä»¥æŸå¤±ç²¾åº¦ä¸ºä»£ä»·çš„ã€‚

å¤§æ¨¡å‹çš„æ¨ç†é€Ÿåº¦é€šå¸¸é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæŒ‡æ ‡è¿›è¡Œè¡¡é‡ï¼š

**ååé‡ï¼ˆThroughputï¼‰**

- **å®šä¹‰**ï¼šå•ä½æ—¶é—´å†…æ¨¡å‹å¤„ç†çš„æ ·æœ¬æ•°é‡ï¼Œé€šå¸¸ä»¥æ¯ç§’å¤„ç†çš„æ ·æœ¬æ•°ï¼ˆsamples per secondï¼‰æˆ–æ¯ç§’å¤„ç†çš„æ ‡è®°æ•°ï¼ˆtokens per secondï¼‰æ¥è¡¨ç¤ºã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé«˜ååé‡åœ¨éœ€è¦å¿«é€Ÿå¤„ç†å¤§é‡æ•°æ®çš„åœºæ™¯ï¼ˆå¦‚æ‰¹é‡å¤„ç†ä»»åŠ¡ï¼‰ä¸­éå¸¸é‡è¦ã€‚

**å»¶è¿Ÿï¼ˆLatencyï¼‰**

- **å®šä¹‰**ï¼šå¤„ç†å•ä¸ªè¾“å…¥æ‰€éœ€çš„æ—¶é—´ï¼Œé€šå¸¸ä»¥æ¯«ç§’ï¼ˆmsï¼‰ä¸ºå•ä½ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šä½å»¶è¿Ÿåœ¨å®æ—¶åº”ç”¨ï¼ˆå¦‚èŠå¤©æœºå™¨äººã€åœ¨çº¿ç¿»è¯‘ç­‰ï¼‰ä¸­éå¸¸å…³é”®ï¼Œç”¨æˆ·å¸Œæœ›è·å¾—å³æ—¶å“åº”ã€‚

**æ¯æ¬¡æ¨ç†çš„æ—¶é—´ï¼ˆInference Time per Sampleï¼‰**

- **å®šä¹‰**ï¼šå¤„ç†å•ä¸ªè¾“å…¥æ ·æœ¬ä»å¼€å§‹åˆ°ç»“æŸæ‰€éœ€çš„æ€»æ—¶é—´ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šåœ¨è¯„ä¼°å•ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´æ—¶ï¼Œè¿™ä¸ªæŒ‡æ ‡å¾ˆæœ‰ç”¨ã€‚

**å†…å­˜ä½¿ç”¨ï¼ˆMemory Usageï¼‰**

- **å®šä¹‰**ï¼šæ¨ç†è¿‡ç¨‹ä¸­æ‰€éœ€çš„å†…å­˜é‡ï¼Œé€šå¸¸ä»¥GBä¸ºå•ä½ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šåœ¨èµ„æºå—é™çš„ç¯å¢ƒï¼ˆå¦‚ç§»åŠ¨è®¾å¤‡æˆ–åµŒå…¥å¼ç³»ç»Ÿï¼‰ä¸­ï¼Œéœ€è¦å…³æ³¨å†…å­˜ä½¿ç”¨æƒ…å†µã€‚

**è®¡ç®—æˆæœ¬ï¼ˆCompute Costï¼‰**

- **å®šä¹‰**ï¼šæ¨ç†è¿‡ç¨‹ä¸­æ‰€éœ€çš„è®¡ç®—èµ„æºï¼Œé€šå¸¸ä»¥FLOPsï¼ˆæ¯ç§’æµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼‰æ¥è¡¨ç¤ºã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šè¯„ä¼°è®¡ç®—èµ„æºçš„éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§å‹é›†ç¾¤æˆ–äº‘è®¡ç®—ç¯å¢ƒä¸­ï¼Œè®¡ç®—æˆæœ¬ä¼šå½±å“ç»æµæ•ˆç›Šã€‚



### å¿«é€Ÿæ±‡æ€»

| **é‡åŒ–æ–¹æ³•** | **å†…å­˜éœ€æ±‚å‡å°‘** | **ç²¾åº¦æŸå¤±**      | **ä¼˜ç‚¹**                     | **åº”ç”¨åœºæ™¯**                             | **æ¨ç†é€Ÿåº¦**   |
| ------------ | ---------------- | ----------------- | ---------------------------- | ---------------------------------------- | -------------- |
| **FP16**     | çº¦50%            | é€šå¸¸åœ¨1%ä»¥å†…      | å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œä¿æŒé«˜ç²¾åº¦     | è®­ç»ƒå’Œæ¨ç†é˜¶æ®µ                           | æé«˜1.5å€åˆ°2å€ |
| **INT8**     | çº¦75%            | 1%åˆ°5%            | æ˜¾è‘—å‡å°‘å†…å­˜å’Œè®¡ç®—èµ„æºéœ€æ±‚   | ä¸»è¦ç”¨äºæ¨ç†ï¼Œç‰¹åˆ«æ˜¯åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Š   | æé«˜2å€åˆ°4å€   |
| **INT4**     | çº¦87.5%          | 5%åˆ°10%ï¼Œæœ‰æ—¶æ›´é«˜ | è¿›ä¸€æ­¥å‡å°‘å†…å­˜å’Œè®¡ç®—èµ„æºéœ€æ±‚ | å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜æˆ–å¯å®¹å¿è¾ƒå¤§ç²¾åº¦æŸå¤±çš„ä»»åŠ¡ | æé«˜4å€åˆ°8å€   |

